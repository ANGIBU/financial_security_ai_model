# prompt_enhancer.py

import random

class PromptEnhancer:
    """프롬프트 구성 및 Few-shot 예시 관리"""
    
    def __init__(self):
        self._initialize_few_shot_examples()
        self._initialize_prompt_templates()
    
    def _initialize_few_shot_examples(self):
        """Few-shot 예시 초기화"""
        
        self.few_shot_examples = {
            "사이버보안": {
                "multiple_choice": [
                    {
                        "question": "다음 중 트로이 목마의 주요 특징으로 가장 적절한 것은?\n1 자가 복제 기능\n2 정상 프로그램 위장\n3 네트워크 속도 저하\n4 파일 암호화\n5 화면 잠금",
                        "answer": "2",
                        "reasoning": "트로이 목마는 정상 프로그램으로 위장하여 사용자가 자발적으로 설치하도록 유도하는 것이 주요 특징입니다."
                    },
                    {
                        "question": "SBOM을 금융권에서 활용하는 가장 적절한 이유는?\n1 데이터 백업\n2 네트워크 모니터링\n3 접근 권한 관리\n4 암호화 강화\n5 소프트웨어 공급망 보안",
                        "answer": "5",
                        "reasoning": "SBOM은 소프트웨어 구성 요소의 투명성을 제공하여 공급망 보안을 강화하는 목적으로 활용됩니다."
                    },
                    {
                        "question": "악성코드 탐지를 위한 행동 분석 기법으로 가장 적절한 것은?\n1 파일 크기 변경 감지\n2 비정상적인 네트워크 통신 패턴 분석\n3 시스템 부팅 시간 측정\n4 하드웨어 사용률 모니터링\n5 사용자 인터페이스 변경 추적",
                        "answer": "2",
                        "reasoning": "악성코드는 외부 서버와의 비정상적인 통신을 통해 명령을 받거나 데이터를 전송하므로 네트워크 패턴 분석이 효과적입니다."
                    },
                    {
                        "question": "딥페이크 기술의 악용을 방지하기 위한 기술적 대응 방안으로 가장 적절한 것은?\n1 비밀번호 복잡도 강화\n2 다중 인증 체계 구축\n3 방화벽 설정 강화\n4 백업 주기 단축\n5 안티바이러스 업데이트",
                        "answer": "2",
                        "reasoning": "딥페이크는 신원 위조 공격에 사용되므로 다중 인증을 통한 신원 검증 강화가 가장 효과적입니다."
                    },
                    {
                        "question": "사이버 공격 대응을 위한 SIEM 시스템의 주요 기능으로 가장 적절한 것은?\n1 사용자 교육 자료 제공\n2 하드웨어 성능 최적화\n3 실시간 보안 이벤트 분석\n4 소프트웨어 라이선스 관리\n5 네트워크 대역폭 할당",
                        "answer": "3",
                        "reasoning": "SIEM은 보안 정보 및 이벤트 관리 시스템으로 실시간 로그 분석과 위협 탐지가 핵심 기능입니다."
                    },
                    {
                        "question": "랜섬웨어 공격 피해 최소화를 위한 예방 조치로 가장 적절한 것은?\n1 화면보호기 설정\n2 정기적인 백업 수행\n3 글꼴 설치 제한\n4 바탕화면 변경 금지\n5 사운드 볼륨 조절",
                        "answer": "2",
                        "reasoning": "랜섬웨어는 파일을 암호화하여 사용할 수 없게 만들므로, 정기적인 백업을 통해 복구 가능성을 확보하는 것이 핵심입니다."
                    }
                ],
                "subjective": [
                    {
                        "question": "트로이 목마 기반 원격제어 악성코드의 특징과 주요 탐지 지표를 설명하세요.",
                        "answer": "트로이 목마 기반 원격제어 악성코드는 정상 프로그램으로 위장하여 사용자가 자발적으로 설치하도록 유도하는 특징을 가집니다. 설치 후 외부 공격자가 원격으로 시스템을 제어할 수 있는 백도어를 생성하며, 은밀성과 지속성을 통해 장기간 시스템에 잠복합니다. 주요 탐지 지표로는 비정상적인 네트워크 통신 패턴, 비인가 프로세스 실행, 파일 시스템 변경, 레지스트리 수정, 시스템 성능 저하 등이 있으며, 실시간 모니터링을 통한 종합적 분석이 필요합니다."
                    },
                    {
                        "question": "딥페이크 기술 악용에 대비한 금융권 대응 방안을 기술하세요.",
                        "answer": "딥페이크 기술 악용에 대비하여 다층 방어체계 구축이 필요합니다. 생체인증과 다중 인증 체계를 통한 신원 검증 강화, 실시간 탐지 시스템 도입을 통한 딥페이크 콘텐츠 식별, 직원 교육 및 인식 제고를 통한 사회공학 공격 대응 능력 향상이 핵심입니다. 또한 AI 기반 탐지 기술과 블록체인을 활용한 디지털 서명 시스템을 구축하여 콘텐츠 무결성을 보장하고, 지속적인 모니터링과 대응 체계를 운영해야 합니다."
                    }
                ]
            },
            "전자금융": {
                "multiple_choice": [
                    {
                        "question": "한국은행이 금융통화위원회의 요청에 따라 전자금융업자에게 자료제출을 요구할 수 있는 경우로 가장 적절한 것은?\n1 보안 시스템 점검\n2 고객 정보 확인\n3 경영 실적 조사\n4 통화신용정책 수행\n5 시장 동향 파악",
                        "answer": "4",
                        "reasoning": "한국은행법에 따라 통화신용정책의 수행 및 지급결제제도의 원활한 운영을 위해 자료제출을 요구할 수 있습니다."
                    },
                    {
                        "question": "전자금융거래에서 이용자 보호를 위한 접근매체 관리 원칙으로 가장 적절한 것은?\n1 접근매체 공유 허용\n2 접근매체 안전한 보관\n3 접근매체 복사본 생성\n4 접근매체 타인 위탁 관리\n5 접근매체 분실 시 방치",
                        "answer": "2",
                        "reasoning": "전자금융거래법에서 이용자는 접근매체를 안전하게 보관하고 제3자에게 대여하거나 사용을 위임해서는 안 됩니다."
                    },
                    {
                        "question": "전자금융업자의 보안강화 의무 사항으로 가장 적절한 것은?\n1 고객 개인정보 공개\n2 암호화 조치 생략\n3 전자금융거래 기록 보존\n4 보안시스템 미설치\n5 사고 대응체계 미운영",
                        "answer": "3",
                        "reasoning": "전자금융거래법에 따라 전자금융업자는 전자금융거래 기록을 일정 기간 보존하고 보안시스템을 구축해야 합니다."
                    },
                    {
                        "question": "전자금융분쟁조정위원회의 역할로 가장 적절한 것은?\n1 신용등급 평가\n2 대출 승인\n3 분쟁조정 업무\n4 상품 개발\n5 마케팅 전략 수립",
                        "answer": "3",
                        "reasoning": "전자금융분쟁조정위원회는 전자금융거래 관련 분쟁의 조정 업무를 담당합니다."
                    },
                    {
                        "question": "전자서명의 법적 효력 인정 요건으로 가장 적절한 것은?\n1 수기 서명과 동일한 색상\n2 서명자 신원 확인 가능성\n3 종이 문서에만 사용\n4 특정 글꼴 사용\n5 인쇄 후 보관",
                        "answer": "2",
                        "reasoning": "전자서명법에서 전자서명이 법적 효력을 갖기 위해서는 서명자의 신원 확인과 문서의 변경 여부 확인이 가능해야 합니다."
                    },
                    {
                        "question": "전자금융거래 과정에서 발생한 손해에 대한 책임 분담 원칙으로 가장 적절한 것은?\n1 모든 책임은 이용자가 부담\n2 모든 책임은 전자금융업자가 부담\n3 과실 책임에 따른 분담\n4 손해액의 절반씩 분담\n5 제3자가 모든 책임 부담",
                        "answer": "3",
                        "reasoning": "전자금융거래법에서는 이용자와 전자금융업자 각자의 과실 정도에 따라 책임을 분담하도록 규정하고 있습니다."
                    }
                ],
                "subjective": [
                    {
                        "question": "전자금융거래 분쟁조정을 신청할 수 있는 기관을 기술하세요.",
                        "answer": "전자금융분쟁조정위원회에서 전자금융거래 관련 분쟁조정 업무를 담당합니다. 이 위원회는 금융감독원 내에 설치되어 운영되며, 전자금융거래법에 근거하여 이용자와 전자금융업자 간의 분쟁을 공정하고 신속하게 해결하기 위한 업무를 수행합니다."
                    },
                    {
                        "question": "전자금융거래의 안전성 확보를 위한 기술적 보안 조치를 설명하세요.",
                        "answer": "전자금융거래의 안전성 확보를 위해 접근매체에 대한 위조나 변조 방지 조치, 거래정보에 대한 암호화 조치, 전자금융거래 기록의 위조나 변조 방지를 위한 조치를 시행해야 합니다. 또한 전자금융업자는 안전성이나 신뢰성 확보에 필요한 인력과 전산설비, 전자금융프로그램을 갖추고 이를 지속적으로 점검하여 보안 수준을 유지해야 합니다."
                    }
                ]
            },
            "개인정보보호": {
                "multiple_choice": [
                    {
                        "question": "만 14세 미만 아동의 개인정보 처리를 위해 필요한 절차로 가장 적절한 것은?\n1 본인의 직접 동의\n2 법정대리인의 동의\n3 학교의 승인\n4 관할 기관 허가\n5 보호자 확인서",
                        "answer": "2",
                        "reasoning": "개인정보보호법에 따라 만 14세 미만 아동의 개인정보 처리에는 법정대리인의 동의가 필요합니다."
                    },
                    {
                        "question": "개인정보 처리방침에 포함되어야 할 필수 사항으로 가장 적절한 것은?\n1 직원 연락처\n2 개인정보 처리 목적\n3 회사 연혁\n4 사업 계획서\n5 재무 상태",
                        "answer": "2",
                        "reasoning": "개인정보보호법에서 개인정보 처리방침에는 개인정보의 처리 목적, 항목, 보유기간 등이 필수로 포함되어야 합니다."
                    },
                    {
                        "question": "개인정보보호법상 정보주체의 권리로 가장 적절한 것은?\n1 무제한 정보 제공 요구\n2 개인정보 처리 현황 열람\n3 타인 정보 접근\n4 개인정보 임의 변경\n5 법정대리인 권한 무시",
                        "answer": "2",
                        "reasoning": "개인정보보호법에서 정보주체는 자신의 개인정보 처리 현황에 대한 열람을 요구할 권리를 가집니다."
                    },
                    {
                        "question": "개인정보 수집 시 동의 획득 방식으로 가장 적절한 것은?\n1 묵시적 동의\n2 포괄적 동의\n3 명시적 동의\n4 추정 동의\n5 사후 동의",
                        "answer": "3",
                        "reasoning": "개인정보보호법에서는 개인정보 수집 시 정보주체로부터 명시적이고 구체적인 동의를 받아야 합니다."
                    },
                    {
                        "question": "개인정보 파기 시점에 대한 규정으로 가장 적절한 것은?\n1 수집 후 즉시\n2 처리 목적 달성 시\n3 1년 후 자동\n4 정보주체 요청 시만\n5 영구 보존",
                        "answer": "2",
                        "reasoning": "개인정보보호법에 따라 개인정보는 처리 목적이 달성된 때에는 지체 없이 파기해야 합니다."
                    },
                    {
                        "question": "개인정보 처리위탁 시 위탁자의 의무사항으로 가장 적절한 것은?\n1 위탁업무 미감독\n2 수탁자에 대한 관리감독\n3 위탁계약 구두 체결\n4 개인정보 무제한 제공\n5 수탁자 선정 기준 미적용",
                        "answer": "2",
                        "reasoning": "개인정보보호법에서 개인정보 처리를 위탁하는 경우 위탁자는 수탁자에 대한 관리감독 의무를 가집니다."
                    }
                ],
                "subjective": [
                    {
                        "question": "개인정보 침해 신고 및 상담을 담당하는 기관을 기술하세요.",
                        "answer": "개인정보보호위원회에서 개인정보 보호에 관한 업무를 총괄하며, 개인정보침해신고센터에서 신고 접수 및 상담 업무를 담당합니다. 개인정보보호위원회는 개인정보보호법에 따라 설치된 중앙행정기관으로 개인정보 보호 정책 수립과 감시 업무를 수행합니다."
                    }
                ]
            },
            "정보보안": {
                "multiple_choice": [
                    {
                        "question": "재해 복구 계획 수립 시 고려 요소 중 옳지 않은 것은?\n1 복구 절차 수립\n2 비상연락체계 구축\n3 개인정보 파기 절차\n4 복구 목표시간 설정\n5 백업 시스템 구축",
                        "answer": "3",
                        "reasoning": "개인정보 파기 절차는 재해 복구 계획과 직접적인 관련이 없으며, 복구 관련 요소가 아닙니다."
                    },
                    {
                        "question": "정보보안관리체계 구축을 위한 핵심 요소로 가장 적절한 것은?\n1 직원 복리후생\n2 보안정책 수립\n3 사무용품 관리\n4 건물 인테리어\n5 차량 관리",
                        "answer": "2",
                        "reasoning": "정보보안관리체계의 핵심은 조직의 보안정책 수립과 이를 바탕으로 한 체계적인 보안 관리입니다."
                    },
                    {
                        "question": "접근통제 정책 수립 시 고려해야 할 원칙으로 가장 적절한 것은?\n1 모든 사용자에게 동일한 권한 부여\n2 최소권한 원칙 적용\n3 권한 검토 불필요\n4 영구적 권한 부여\n5 권한 위임 무제한 허용",
                        "answer": "2",
                        "reasoning": "접근통제의 기본 원칙은 업무 수행에 필요한 최소한의 권한만을 부여하는 것입니다."
                    },
                    {
                        "question": "암호화 정책 수립 시 고려사항으로 가장 적절한 것은?\n1 암호키 공개 보관\n2 단순한 암호화 알고리즘 사용\n3 암호키 관리 체계 구축\n4 암호화 생략\n5 암호키 공유 확대",
                        "answer": "3",
                        "reasoning": "효과적인 암호화를 위해서는 암호키의 생성, 배포, 저장, 폐기 등을 포함한 체계적인 관리가 필요합니다."
                    },
                    {
                        "question": "보안 감사 수행 시 핵심 검토 대상으로 가장 적절한 것은?\n1 사무용품 사용 내역\n2 보안정책 준수 현황\n3 직원 출입 시간\n4 전기 사용량\n5 사무실 온도",
                        "answer": "2",
                        "reasoning": "보안 감사는 수립된 보안정책과 절차가 실제로 준수되고 있는지를 확인하는 것이 핵심입니다."
                    },
                    {
                        "question": "보안사고 대응체계 구축 시 우선적으로 고려할 사항은?\n1 사고 은폐 방법\n2 사고 대응 절차 수립\n3 책임 회피 방안\n4 언론 대응 방법\n5 법적 대리인 선임",
                        "answer": "2",
                        "reasoning": "효과적인 보안사고 대응을 위해서는 사전에 명확한 대응 절차와 역할 분담을 정의해야 합니다."
                    }
                ]
            },
            "금융투자": {
                "multiple_choice": [
                    {
                        "question": "금융산업의 이해와 관련하여 금융투자업의 구분에 해당하지 않는 것은?\n1 소비자금융업\n2 투자자문업\n3 투자매매업\n4 투자중개업\n5 보험중개업",
                        "answer": "1",
                        "reasoning": "소비자금융업은 금융투자업에 해당하지 않으며, 별도의 금융업 분류에 속합니다."
                    },
                    {
                        "question": "자본시장법상 투자자 보호를 위한 기본 원칙으로 가장 적절한 것은?\n1 고수익 투자상품 우선 판매\n2 적합성 원칙 준수\n3 투자 위험 최소화\n4 모든 고객에게 동일한 상품 제공\n5 투자자 경험 무시",
                        "answer": "2",
                        "reasoning": "자본시장법에서는 투자자의 투자 경험, 재산 상황, 투자 목적 등에 적합한 상품을 권유하는 적합성 원칙을 규정하고 있습니다."
                    },
                    {
                        "question": "금융투자회사의 내부통제 시스템 구축 목적으로 가장 적절한 것은?\n1 직원 수 증가\n2 시설 확장\n3 리스크 관리 및 컴플라이언스 확보\n4 매출 증대\n5 고객 수 증가",
                        "answer": "3",
                        "reasoning": "내부통제 시스템은 업무 프로세스에서 발생할 수 있는 리스크를 관리하고 법규 준수를 보장하기 위해 구축됩니다."
                    }
                ]
            },
            "위험관리": {
                "multiple_choice": [
                    {
                        "question": "위험 관리 계획 수립 시 고려해야 할 요소로 적절하지 않은 것은?\n1 수행인력\n2 위험 수용\n3 위험 대응 전략 선정\n4 대상\n5 기간",
                        "answer": "2",
                        "reasoning": "위험 관리 계획에서 위험 수용은 적절한 관리 요소가 아니며, 위험을 식별하고 대응하는 것이 중요합니다."
                    },
                    {
                        "question": "위험 식별 단계에서 우선적으로 고려해야 할 사항은?\n1 위험 발생 가능성과 영향도 분석\n2 위험 대응 비용 산정\n3 위험 담당자 지정\n4 위험 보고서 작성\n5 위험 관련 교육 실시",
                        "answer": "1",
                        "reasoning": "위험 식별 시에는 각 위험의 발생 가능성과 조직에 미칠 영향의 정도를 분석하는 것이 우선입니다."
                    },
                    {
                        "question": "위험 대응 전략 중 위험 회피에 대한 설명으로 가장 적절한 것은?\n1 위험을 그대로 받아들임\n2 위험 발생 원인을 제거\n3 위험을 제3자에게 전가\n4 위험 발생 가능성을 감소\n5 위험 영향도를 최소화",
                        "answer": "2",
                        "reasoning": "위험 회피는 위험이 발생할 수 있는 원인이나 활동 자체를 제거하여 위험을 원천적으로 차단하는 전략입니다."
                    },
                    {
                        "question": "위험 모니터링 활동의 주요 목적으로 가장 적절한 것은?\n1 직원 성과 평가\n2 위험 관리 효과성 점검\n3 예산 집행 현황 확인\n4 고객 만족도 조사\n5 시설 이용률 분석",
                        "answer": "2",
                        "reasoning": "위험 모니터링은 수립된 위험 관리 계획이 효과적으로 작동하고 있는지를 지속적으로 점검하는 활동입니다."
                    }
                ]
            }
        }
    
    def _initialize_prompt_templates(self):
        """프롬프트 템플릿 초기화"""
        
        self.prompt_templates = {
            "multiple_choice_base": """다음은 금융보안 관련 객관식 문제입니다. 주어진 선택지 중에서 가장 적절한 답을 선택하세요.

{few_shot_examples}

문제: {question}

위 문제를 다음 단계로 분석하여 정답을 선택하세요:
1. 문제의 핵심 키워드와 요구사항 파악
2. 각 선택지를 해당 법령과 규정에 따라 검토
3. 문제 유형(부정/긍정)에 따른 논리적 추론
4. 전문가 관점에서 최적의 답안 선택

정답 번호: """,

            "subjective_base": """다음은 금융보안 관련 주관식 문제입니다. 전문적이고 정확한 답변을 작성하세요.

{few_shot_examples}

참고 정보:
{context_info}

문제: {question}

위 문제에 대해 다음 관점에서 체계적으로 답변하세요:
1. 관련 법령과 규정의 근거 제시
2. 핵심 개념과 원리 설명
3. 구체적인 절차나 방법론 기술
4. 실무 적용 시 고려사항 포함

답변: """,

            "institution_question": """다음은 금융보안 관련 기관에 대한 질문입니다.

{few_shot_examples}

기관 정보:
{institution_info}

문제: {question}

위 질문에 대해 다음 요소를 포함하여 답변하세요:
1. 정확한 기관명과 소속 조직
2. 법적 근거와 설립 배경
3. 주요 업무와 권한 범위
4. 관련 절차와 연락 방법

답변: """
        }
    
    def build_few_shot_context(self, domain: str, question_type: str, count: int = 3) -> str:
        """Few-shot 예시 구성"""
        try:
            if domain not in self.few_shot_examples:
                return ""
            
            domain_examples = self.few_shot_examples[domain]
            if question_type not in domain_examples:
                return ""
            
            examples = domain_examples[question_type]
            selected_count = min(count, len(examples))
            selected_examples = random.sample(examples, selected_count) if len(examples) > selected_count else examples
            
            few_shot_text = ""
            for i, example in enumerate(selected_examples, 1):
                if question_type == "multiple_choice":
                    few_shot_text += f"예시 {i}:\n문제: {example['question']}\n정답: {example['answer']}\n해설: {example['reasoning']}\n\n"
                else:
                    few_shot_text += f"예시 {i}:\n문제: {example['question']}\n답변: {example['answer']}\n\n"
            
            return few_shot_text
        except Exception as e:
            print(f"Few-shot 컨텍스트 구성 오류: {e}")
            return ""
    
    def build_enhanced_prompt(self, question: str, question_type: str, domain: str = "일반", 
                            context_info: str = "", institution_info: str = "") -> str:
        """프롬프트 구성"""
        try:
            # Few-shot 예시 추가 (도메인에 따라 3-5개)
            example_count = 5 if domain in ["개인정보보호", "전자금융"] else 3
            few_shot_examples = self.build_few_shot_context(domain, question_type, count=example_count)
            
            # 기관 질문 특별 처리
            if ("기관" in question.lower() or "위원회" in question.lower()) and institution_info:
                template = self.prompt_templates["institution_question"]
                return template.format(
                    few_shot_examples=few_shot_examples,
                    institution_info=institution_info,
                    question=question
                )
            
            # 일반 프롬프트
            if question_type == "multiple_choice":
                template = self.prompt_templates["multiple_choice_base"]
                return template.format(
                    few_shot_examples=few_shot_examples,
                    question=question
                )
            else:
                template = self.prompt_templates["subjective_base"]
                return template.format(
                    few_shot_examples=few_shot_examples,
                    context_info=context_info if context_info else "해당 도메인의 관련 법령과 규정을 참고하세요.",
                    question=question
                )
                
        except Exception as e:
            print(f"프롬프트 구성 오류: {e}")
            return f"문제: {question}\n\n위 문제에 대해 전문적이고 정확한 답변을 작성하세요.\n\n답변: "
    
    def get_context_hints(self, domain: str, intent_type: str) -> str:
        """도메인별 컨텍스트 힌트 제공"""
        
        context_hints = {
            "사이버보안": {
                "특징_묻기": "사이버 위협의 기술적 특성과 동작 방식, 은밀성과 지속성을 중심으로 설명하세요.",
                "지표_묻기": "네트워크 트래픽, 프로세스 활동, 파일 시스템 변화 등 구체적인 탐지 지표를 포함하여 설명하세요.",
                "방안_묻기": "다층 방어체계, 실시간 모니터링, 사고 대응 절차를 포함한 종합적 방안을 설명하세요."
            },
            "전자금융": {
                "기관_묻기": "전자금융거래법에 근거한 기관의 법적 지위와 구체적 업무 범위를 명확히 설명하세요.",
                "방안_묻기": "접근매체 보안, 거래 기록 보존, 분쟁조정 절차를 포함한 이용자 보호 방안을 설명하세요.",
                "절차_묻기": "전자금융거래법에 명시된 법적 절차와 당사자별 의무사항을 단계별로 설명하세요."
            },
            "개인정보보호": {
                "기관_묻기": "개인정보보호법에 따른 기관의 권한과 개인정보 처리 감독 업무를 구체적으로 설명하세요.",
                "방안_묻기": "수집 최소화, 목적 제한, 정보주체 권리 보장 원칙을 중심으로 설명하세요.",
                "절차_묻기": "동의 획득, 처리 현황 공개, 권리 행사 절차를 법령에 따라 설명하세요."
            },
            "금융투자": {
                "방안_묻기": "자본시장법의 투자자 보호 원칙과 적합성 원칙 적용 방안을 중심으로 설명하세요."
            },
            "위험관리": {
                "방안_묻기": "위험 식별, 평가, 대응, 모니터링의 4단계 절차와 각 단계별 핵심 활동을 설명하세요."
            },
            "정보보안": {
                "방안_묻기": "정보보안관리체계의 수립, 운영, 점검, 개선 사이클을 중심으로 설명하세요."
            }
        }
        
        try:
            return context_hints.get(domain, {}).get(intent_type, "관련 법령의 구체적 조항과 실무 적용 방안을 포함하여 체계적으로 설명하세요.")
        except Exception:
            return "관련 법령의 구체적 조항과 실무 적용 방안을 포함하여 체계적으로 설명하세요."
    
    def cleanup(self):
        """리소스 정리"""
        pass